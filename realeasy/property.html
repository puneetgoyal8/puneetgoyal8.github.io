<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opening RealEasy...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
        }
    </style>
</head>
<body>
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const deepLinkPath = window.location.pathname;
        const allParams = {};
        
        urlParams.forEach((value, key) => {
            allParams[key] = value;
        });

        // Play Store URL (WhatsApp as placeholder - CHANGE THIS WHEN YOU PUBLISH)
        const PLAY_STORE_URL = 'https://play.google.com/store/apps/details?id=com.whatsapp';
        
        // Custom scheme URL
        let customSchemeUrl = 'realeasy://';
        
        // Remove /realeasy prefix from path for matching
        const cleanPath = deepLinkPath.replace('/realeasy', '');
        
        // Detect the type of deep link
        if (cleanPath.includes('/property')) {
            const propertyId = allParams.id || allParams.property_id || '';
            customSchemeUrl += `property?id=${propertyId}`;
            
            // Add all other params
            Object.keys(allParams).forEach(key => {
                if (key !== 'id' && key !== 'property_id') {
                    customSchemeUrl += `&${key}=${allParams[key]}`;
                }
            });
        } else if (cleanPath.includes('/propertyRegistration')) {
            customSchemeUrl += 'propertyRegistration?';
            const params = [];
            if (allParams.task_id) params.push(`task_id=${allParams.task_id}`);
            if (allParams.profile_id) params.push(`profile_id=${allParams.profile_id}`);
            if (allParams.property_id) params.push(`property_id=${allParams.property_id}`);
            customSchemeUrl += params.join('&');
        } else {
            // Generic deep link - pass all params
            const paramString = urlParams.toString();
            if (paramString) {
                customSchemeUrl += `open?${paramString}`;
            } else {
                customSchemeUrl += 'open';
            }
        }

        console.log('Deep link URL:', customSchemeUrl);

        // Track if app was opened
        let appOpened = false;
        const startTime = Date.now();

        // Detect if user left the page (app opened)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                appOpened = true;
            }
        });

        window.addEventListener('blur', function() {
            appOpened = true;
        });

        window.addEventListener('pagehide', function() {
            appOpened = true;
        });

        // Try to open the app IMMEDIATELY
        function attemptAppOpen() {
            // Method 1: Try iframe (silent, no visible effect)
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = customSchemeUrl;
            document.body.appendChild(iframe);

            // Method 2: Try window.location as backup
            setTimeout(() => {
                if (!appOpened) {
                    try {
                        window.location.href = customSchemeUrl;
                    } catch (e) {
                        // Ignore errors
                    }
                }
            }, 25);
        }

        // Instant redirect to Play Store if app not opened
        function checkAndRedirect() {
            setTimeout(() => {
                const elapsed = Date.now() - startTime;
                
                // If more than 800ms passed and app not opened, redirect to Play Store
                if (!appOpened && elapsed > 800) {
                    window.location.href = PLAY_STORE_URL;
                }
            }, 1000); // Wait 1 second before giving up
        }

        // Execute immediately
        attemptAppOpen();
        checkAndRedirect();
    </script>
</body>
</html>
